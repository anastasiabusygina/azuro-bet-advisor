# Задача: Исправление отображения названий кнопок в скрипте get_match_buttons.sh

## Общая информация

**Название задачи**: Улучшение механизма определения типов ставок в скрипте get_match_buttons.sh

**Краткое описание**: В настоящее время скрипт get_match_buttons.sh использует жестко закодированное сопоставление ID исходов ставок с их типами и параметрами, что приводит к неправильному отображению названий кнопок. Необходимо переработать скрипт таким образом, чтобы он получал корректную информацию о типах ставок и их параметрах непосредственно из API Azuro, без использования жестко закодированных маппингов.

**Основные требования**:
- Изменить GraphQL запрос для получения полной информации о типах ставок и их параметрах
- Устранить все жестко закодированные сопоставления ID со ставками
- Обеспечить корректное отображение названий кнопок в интерфейсе
- Улучшить обработку случаев, когда API не предоставляет нужную информацию
- Сохранить обратную совместимость с существующими вызовами скрипта

**Критерии успешного выполнения**:
- Скрипт корректно отображает названия кнопок ставок, соответствующие интерфейсу Azuro
- Отсутствуют жестко закодированные маппинги ID ставок
- Скрипт корректно обрабатывает ситуации отсутствия данных
- Все существующие параметры и опции скрипта продолжают работать

**Номер родительской задачи**: #undefined

## Анализ кодовой базы

**Список связанных файлов**:
- `get_match_buttons.sh` - основной скрипт, требующий модификации

**Архитектурные компоненты, которые будут затронуты**:
- Механизм запросов к API Azuro (GraphQL запросы)
- Логика обработки и преобразования данных о ставках
- Форматирование вывода для пользователя

**Существующие реализации похожей функциональности**:
- Текущая реализация использует жестко закодированное сопоставление ID исходов с типами ставок и их параметрами
- Для вывода информации о рекомендованной ставке используются функции `highlight_recommended_bet` и `show_recommended_button`

## Капсулы

## Капсула 1: Исследование GraphQL API Azuro и расширение запроса

### Описание
Исследовать текущую схему GraphQL API Azuro и определить, какие поля доступны для получения информации о типах ставок и их параметрах. Расширить существующий запрос GraphQL для получения этой информации без необходимости использования жестко закодированных маппингов.

### Файлы для изменения
- `get_match_buttons.sh` - изменение GraphQL запроса для получения полной информации о типах ставок

### Шаги выполнения
1. Исследовать схему GraphQL API Azuro через инструменты разработчика или документацию API
2. Определить, какие поля доступны для получения информации о типах ставок и их параметрах
3. Модифицировать GraphQL запрос `FULL_QUERY` (примерно строки 455-467) для включения дополнительных полей с информацией о типах ставок и параметрах
4. Добавить отладочный вывод для проверки результатов запроса
5. Проверить корректность запроса на реальных данных

### Пример модификации GraphQL запроса:
```graphql
query GetFullGameDetails($id: ID!) {
  game(id: $id) {
    id
    gameId
    title
    status
    startsAt
    sport {
      name
    }
    league {
      name
    }
    conditions {
      id
      conditionId
      status
      marketName      # Добавленное поле для имени рынка/типа ставки
      marketParameter # Добавленное поле для параметра ставки
      outcomes {
        id
        outcomeId
        title
        currentOdds
        outcomeParameter # Добавленное поле для параметра исхода
      }
    }
  }
}
```

### Критерии завершения
- GraphQL запрос успешно получает информацию о типах ставок и их параметрах
- Отладочный вывод подтверждает наличие нужных полей в ответе API
- При отсутствии нужных полей в схеме API выработана альтернативная стратегия

### Коммит
feat: extend GraphQL query to fetch bet types and parameters #undefined

## Капсула 2: Удаление жестко закодированного маппинга и использование данных API

### Описание
Модифицировать логику скрипта для использования данных о типах ставок и параметрах, полученных непосредственно из API, вместо использования жестко закодированных маппингов. Обеспечить корректную обработку случаев, когда API не предоставляет нужную информацию.

### Файлы для изменения
- `get_match_buttons.sh` - удаление жестко закодированных маппингов и обновление логики обработки данных

### Шаги выполнения
1. Удалить существующую логику определения типа ставки на основе ID исходов (примерно строки 428-440)
2. Обновить логику формирования JSON-файла с данными о матче для использования полей из API
3. Модифицировать функцию `format_ui_style_output` для корректного отображения информации
4. Обновить функцию `highlight_recommended_bet` для использования данных из API
5. Обновить функцию `show_recommended_button` для использования данных из API
6. Добавить обработку случаев, когда API не предоставляет нужную информацию

### Пример модификации логики:
```bash
# Вместо:
if [[ $OUTCOMES_IDS == *"1 "* && $OUTCOMES_IDS == *"2 "* ]]; then
  # ID 1 и 2 обычно относятся к ставкам на Over/Under
  BET_TYPE="Total Goals"
  PARAMETER="2.5" # Предположение для Over/Under
elif [[ $OUTCOMES_IDS == *"29 "* && $OUTCOMES_IDS == *"30 "* && $OUTCOMES_IDS == *"31 "* ]]; then
  # ID 29, 30, 31 обычно относятся к ставкам на 1X2
  BET_TYPE="1X2 (Основной исход)"
# ...

# Использовать:
# Получаем данные напрямую из API
BET_TYPE=$(echo $condition | jq -r '.marketName // "Unknown"')
PARAMETER=$(echo $condition | jq -r '.marketParameter // "null"')

# Если API не предоставляет информацию, используем более общий подход
if [ "$BET_TYPE" = "Unknown" ] || [ "$BET_TYPE" = "null" ]; then
  BET_TYPE="Condition #$CONDITION_ID"
fi
```

### Критерии завершения
- Удалены все жестко закодированные маппинги ID ставок
- Скрипт использует информацию о типах ставок и параметрах, полученную из API
- Добавлена корректная обработка случаев, когда API не предоставляет нужную информацию
- Скрипт корректно отображает информацию о ставках

### Коммит
feat: remove hardcoded mappings and use API data for bet types #undefined

## Капсула 3: Улучшение отображения названий исходов ставок

### Описание
Улучшить логику определения и форматирования названий исходов ставок для обеспечения более понятного и соответствующего интерфейсу Azuro отображения.

### Файлы для изменения
- `get_match_buttons.sh` - обновление логики определения и форматирования названий исходов ставок

### Шаги выполнения
1. Обновить логику определения названий исходов ставок для использования данных из API (примерно строки 467-482)
2. Улучшить форматирование вывода для различных типов ставок и параметров
3. Добавить гибкую обработку случаев, когда API не предоставляет нужную информацию о названии исхода
4. Обеспечить совместимость с существующими вызовами скрипта
5. Обновить функцию `show_recommended_button` для корректного отображения названия рекомендуемой кнопки

### Пример модификации логики:
```bash
# Вместо:
if [ "$OUTCOME_TITLE" = "null" ]; then
  if [[ "$BET_TYPE" == "1X2 (Основной исход)" ]]; then
    if [ "$OUTCOME_ID" = "29" ]; then
      OUTCOME_TITLE="1"
    elif [ "$OUTCOME_ID" = "30" ]; then
      OUTCOME_TITLE="X"
    elif [ "$OUTCOME_ID" = "31" ]; then
      OUTCOME_TITLE="2"
    fi
  elif [[ "$BET_TYPE" == "Total Goals" ]]; then
    if [ "$OUTCOME_ID" = "1" ]; then
      OUTCOME_TITLE="Over ($PARAMETER)"
    elif [ "$OUTCOME_ID" = "2" ]; then
      OUTCOME_TITLE="Under ($PARAMETER)"
    fi
  fi
  
  # Если заголовок все еще не определен, используем ID исхода
  if [ "$OUTCOME_TITLE" = "null" ]; then
    OUTCOME_TITLE="Outcome #$OUTCOME_ID"
  fi
fi

# Использовать:
# Получаем название исхода из API
OUTCOME_TITLE=$(echo $outcome | jq -r '.title')
OUTCOME_PARAMETER=$(echo $outcome | jq -r '.outcomeParameter // "null"')

# Если API не предоставляет название, формируем его на основе параметров
if [ "$OUTCOME_TITLE" = "null" ] || [ -z "$OUTCOME_TITLE" ]; then
  # Используем информацию о параметре исхода, если она доступна
  if [ "$OUTCOME_PARAMETER" != "null" ] && [ ! -z "$OUTCOME_PARAMETER" ]; then
    OUTCOME_TITLE="$OUTCOME_PARAMETER"
  else
    # Если нет никакой информации, используем ID исхода
    OUTCOME_TITLE="Outcome #$OUTCOME_ID"
  fi
fi

# Улучшаем форматирование для конкретных типов ставок
if [[ "$BET_TYPE" == *"Total"* ]] && [[ "$OUTCOME_TITLE" == *"Over"* || "$OUTCOME_TITLE" == *"Under"* ]]; then
  if [ "$PARAMETER" != "null" ] && [ ! -z "$PARAMETER" ]; then
    OUTCOME_TITLE="$OUTCOME_TITLE ($PARAMETER)"
  fi
fi
```

### Критерии завершения
- Скрипт корректно определяет и форматирует названия исходов ставок
- Отображение соответствует интерфейсу Azuro
- Добавлена корректная обработка случаев, когда API не предоставляет нужную информацию
- Функция `show_recommended_button` корректно отображает название рекомендуемой кнопки

### Коммит
feat: improve bet outcome names formatting #undefined

## Капсула 4: Тестирование и отладка

### Описание
Провести комплексное тестирование скрипта на различных типах ставок и матчей для выявления и устранения возможных проблем. Добавить дополнительные отладочные функции для облегчения диагностики проблем в будущем.

### Файлы для изменения
- `get_match_buttons.sh` - добавление отладочных функций и исправление выявленных проблем

### Шаги выполнения
1. Добавить расширенную отладочную функцию для вывода информации о структуре ответа API
2. Протестировать скрипт на различных типах ставок и матчей
3. Выявить и устранить проблемы с обработкой специфических типов ставок
4. Проверить совместимость с существующими вызовами скрипта
5. Улучшить обработку ошибок и вывод сообщений об ошибках
6. Оптимизировать производительность скрипта

### Пример добавления отладочной функции:
```bash
# Функция для отладки структуры ответа API
debug_api_response() {
  local response_file=$1
  
  if [ "$QUIET_MODE" = "false" ]; then
    echo "***** ОТЛАДКА СТРУКТУРЫ ОТВЕТА API *****"
    echo "Доступные поля в условиях:"
    jq '.data.game.conditions[0] | keys' "$response_file"
    
    echo "Пример условия:"
    jq '.data.game.conditions[0]' "$response_file"
    
    echo "Доступные поля в исходах:"
    jq '.data.game.conditions[0].outcomes[0] | keys' "$response_file"
    
    echo "Пример исхода:"
    jq '.data.game.conditions[0].outcomes[0]' "$response_file"
    
    echo "***** КОНЕЦ ОТЛАДКИ *****"
  fi
}

# Вызов функции после получения ответа от API
if [ "$QUIET_MODE" = "false" ]; then
  debug_api_response "$MATCH_DATA_FILE"
fi
```

### Критерии завершения
- Скрипт успешно протестирован на различных типах ставок и матчей
- Выявленные проблемы устранены
- Добавлены отладочные функции для облегчения диагностики проблем
- Улучшена обработка ошибок и вывод сообщений об ошибках
- Скрипт корректно работает со всеми существующими опциями и параметрами

### Коммит
feat: add debugging functions and fix edge cases #undefined

## Капсула 5: Финальная проверка и очистка

### Описание
Тщательная проверка всей реализации, удаление временных отладочных функций и комментариев, финальное тестирование.

### Шаги выполнения
1. Удаление временных отладочных функций и комментариев:
   ```bash
   # Удалить временные отладочные функции
   # Удалить лишние комментарии
   # Оставить только необходимые комментарии на английском языке
   ```

2. Проверка наличия русских комментариев:
   ```bash
   grep -n -E "[а-яА-Я]" get_match_buttons.sh
   ```
   Перевести все русские комментарии на английский

3. Запуск тестов с различными параметрами:
   ```bash
   # Тест базового функционала
   ./get_match_buttons.sh <ID_МАТЧА>
   
   # Тест с рекомендованной ставкой
   ./get_match_buttons.sh -c <CONDITION_ID> -o <OUTCOME_ID> <ID_МАТЧА>
   
   # Тест вывода только названия кнопки
   ./get_match_buttons.sh -b -c <CONDITION_ID> -o <OUTCOME_ID> <ID_МАТЧА>
   ```

4. Проверка корректности отображения информации в интерфейсе Azuro

### Критерии завершения
- Все отладочные функции удалены
- Все комментарии переведены на английский язык
- Скрипт успешно проходит все тесты
- Скрипт корректно отображает названия кнопок в соответствии с интерфейсом Azuro
- Все существующие параметры и опции скрипта продолжают работать
- В коде нет захадкоженных данных, скрипт получает только данные из графа и библиотеки Азуро

### Коммит
feat: finalize match buttons display improvement #undefined

## Важно
- Каждое изменение должно сохранять обратную совместимость с существующими вызовами скрипта
- Не использовать жестко закодированные маппинги ID ставок
- Обеспечить корректную обработку случаев, когда API не предоставляет нужную информацию
- Все комментарии должны быть на английском языке
- Скрипт должен корректно работать со всеми существующими опциями и параметрами 